{%extends "main/base.html"%}

{%block content%}
<div id="app"></div>

<template id="app-template">
    <div class="row justify-content-center">
        <div class="col-12 col-md-6">
            <h3 class="text-center">Bulk SquareFit</h3>
            <div class="card my-3">
                <div class="card-header">
                    <h5 class="card-title m-0">Select Images</h5>
                </div>
                <div class="card-body">
                    <div>
                        <input ref="images" class="form-control" type="file" id="images-input" accept="image/*"
                            @change="onChange" multiple>
                        <div class="mt-2">
                            <p class="mb-2"><strong>Background</strong></p>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="background_opt" id="background-opt-1"
                                    v-model="background.option" value="custom">
                                <label class="form-check-label" for="background-opt-1">
                                    Custom color
                                    <div class="mt-2 d-flex align-items-center">
                                        <input type="color" id="background-color" v-model="background.selected"
                                            :disabled="background.option!='custom'">
                                    </div>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="background_opt" id="background-opt-2"
                                    v-model="background.option" value="dominant">
                                <label class="form-check-label" for="background-opt-2">
                                    Dominant color <br><span class="text-muted small">Dominant color from the
                                        image</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="background_opt" id="background-opt-3"
                                    v-model="background.option" value="blur">
                                <label class="form-check-label" for="background-opt-3">
                                    Blurred <br><span class="text-muted small">Source image blurred in background</span>
                                    <div>
                                        <label for="blur-radius" class="form-label">Blur radius</label>
                                        <input type="range" class="form-range" id="blur-radius" min="1" max="50"
                                            v-model="background.radius" :disabled="background.option!='blur'">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <template v-if="fileList.length>0">
                        <hr>
                        <div class="text-muted mb-2">Preview</div>
                        <div class="row align-items-center">
                            <div class="col-3 border text-center p-0" v-for="(file, index) in fileList" :key="index">
                                <img :src="file" alt="" class="img-fluid" style="height: 100px;object-fit: contain;">
                            </div>
                        </div>
                    </template>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary" :disabled="loading" @click="onSubmit" v-if="!loading">Square
                        Fit'em</button>
                    <div class="progress" v-else>
                        <div class="progress-bar" :class="{'bg-success':percentage==100}" role="progressbar"
                            :style="{'width': percentage+'%'}" :aria-valuenow="percentage" aria-valuemin="0"
                            aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
            <ul class="list-group list-group-flush" v-if="errors">
                <li class="list-group-item text-danger" v-for="(error, index) in errors" :key="index">[[index+1]])
                    [[error]]</li>
            </ul>
        </div>
    </div>
</template>
{%endblock%}

{%block extra_js%}
<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        template: '#app-template',
        data: {
            loading: false,
            errors: [],
            fileList: [],
            background: {
                option: 'custom',
                selected: '#ffffff',
                radius: 8
            },
            progress: {
                total: 0,
                loaded: 0
            }
        },
        computed: {
            percentage() {
                return this.progress.loaded * 100 / (this.progress.total || 1);
            }
        },
        methods: {
            onChange(e) {
                this.fileList = [];
                for (let img of e.target.files) {
                    this.fileList.push(URL.createObjectURL(img));
                }
            },
            removeSelectedFiles() {
                const el = this.$refs.images;
                el.value = null;
                this.onChange({ target: el });
            },
            onSubmit() {
                if (!this.$refs.images?.files?.length) {
                    alert("Add images!");
                    return;
                }
                this.loading = true;
                this.progress.loaded = 0;
                this.progress.total = this.$refs.images.files.length;
                const color = this.background.option == 'custom' ? this.background.selected.replace('#', "") : this.background.option;
                const params = new URLSearchParams()
                params.append('color', color)
                if (color == 'blur')
                    params.append('radius', this.background.radius)
                for (let image of this.$refs.images.files) {
                    let data = new FormData()
                    data.append('image', image);
                    fetch(`?${params.toString()}`, {
                        method: 'POST',
                        body: data,
                    })
                        .then(response => {
                            if (response.ok)
                                return response.blob();
                            else
                                throw new Error(response.statusText)
                        })
                        .then(blob => {
                            var url = window.URL.createObjectURL(blob);
                            var a = document.createElement('a');
                            a.href = url;
                            a.download = `SquareFit ${new Date().getTime().toString(32)}.jpeg`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                        })
                        .catch(err => {
                            this.errors.push(err.message);
                        }).then(() => {
                            this.progress.loaded++;
                            if (this.progress.loaded == this.progress.total) {
                                setTimeout(() => {
                                    this.loading = false;
                                    this.removeSelectedFiles();
                                }, 1000);
                            }
                        });
                }
            }
        }
    })
</script>
{%endblock%}